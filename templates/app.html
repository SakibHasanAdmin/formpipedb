<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FormPipeDB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/app" class="text-2xl font-bold text-black">FormPipeDB</a>
            <div class="relative">
                <button id="profile-btn" class="w-10 h-10 bg-blue-600 text-white flex items-center justify-center rounded-full font-bold text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <!-- Initials will be inserted here by JS -->
                </button>
                <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 py-1 z-10">
                    <div class="px-4 py-2 border-b">
                        <p id="profile-name" class="text-sm font-medium text-gray-900 truncate">Loading...</p>
                        <p id="profile-email" class="text-sm text-gray-500 truncate">...</p>
                    </div>
                    <div class="py-1">
                        <a href="#" id="sign-out-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign Out</a>
                        <a href="/confirm-delete" class="block px-4 py-2 text-sm text-red-700 hover:bg-red-50">Delete Account</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">My Databases</h1>

        <!-- Create New Database -->
        <section class="mb-12 bg-white p-6 rounded-lg shadow-sm border">
            <h2 class="text-xl font-semibold mb-4">Create or Import Database</h2>
            <div class="flex flex-col md:flex-row items-center gap-4">
                <form id="create-db-form" class="w-full flex-grow flex flex-col sm:flex-row items-center gap-4">
                    <input id="new-db-name" type="text" placeholder="project_alpha" required pattern="^[a-z0-9_]+$" title="Use only lowercase letters, numbers, and underscores." class="w-full sm:w-1/3 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" />
                    <input id="new-db-desc" type="text" placeholder="Description (optional)" class="w-full sm:flex-grow p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none" />
                    <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Create</button>
                </form>
                <div class="text-gray-400 hidden md:block">or</div>
                <div class="w-full md:w-auto flex items-center gap-2 text-gray-400 md:hidden">
                    <hr class="flex-grow border-t"><span class="text-sm">OR</span><hr class="flex-grow border-t">
                </div>
                <button id="import-sql-btn" class="w-full md:w-auto bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 whitespace-nowrap">Import SQL...</button>
            </div>
        </section>

        <!-- Manage Existing Databases -->
        <section>
            <h2 class="text-xl font-semibold mb-4">Manage Existing Databases</h2>
            <div id="db-list" class="space-y-4">
                <div id="db-list-placeholder" class="text-center py-10 text-gray-500">
                    Loading databases...
                </div>
            </div>
        </section>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">Confirm Deletion</h3>
            <p>Are you sure you want to delete the database "<strong id="modal-db-name"></strong>"? This action cannot be undone.</p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <!-- Import SQL Modal -->
    <div id="import-sql-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <form id="import-sql-form" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b">
                <h3 class="text-xl font-semibold">Import Database from SQL</h3>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div>
                    <label for="import-db-name" class="block text-sm font-medium text-gray-700">New Database Name</label>
                    <input id="import-db-name" type="text" placeholder="imported_database" required class="mt-1 w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="import-db-desc" class="block text-sm font-medium text-gray-700">Description (optional)</label>
                    <input id="import-db-desc" type="text" class="mt-1 w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="import-sql-script" class="block text-sm font-medium text-gray-700">SQL Script</label>
                    <p class="text-xs text-gray-500 mb-2">Paste your SQL script below or upload a .sql/.txt file. The parser supports simple CREATE TABLE and INSERT INTO statements.</p>
                    <div class="bg-gray-900 text-white p-2 rounded-md font-mono text-sm">
                        <textarea id="import-sql-script" required class="w-full h-64 bg-transparent text-white outline-none resize-vertical" placeholder="CREATE TABLE users (...);"></textarea>
                    </div>
                </div>
                <div>
                    <label for="sql-file-input" class="block text-sm font-medium text-gray-700">Or Upload File</label>
                    <input id="sql-file-input" type="file" accept=".sql,.txt" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>
            <div class="p-6 mt-auto border-t bg-gray-50 flex justify-end gap-4">
                <button id="cancel-import-sql-btn" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="submit-import-sql-btn" type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Import Database</button>
            </div>
        </form>
    </div>

    <script>
        const supabaseUrl = '{{ supabase_url }}';
        const supabaseAnonKey = '{{ supabase_anon_key }}';
        const supabase = supabaseUrl && supabaseAnonKey ? window.supabase.createClient(supabaseUrl, supabaseAnonKey) : null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!supabase) {
                document.body.innerHTML = '<div class="text-center p-8 text-red-600">Supabase client not configured. Please check your environment variables.</div>';
                return;
            }

            const dbList = document.getElementById('db-list');
            const dbListPlaceholder = document.getElementById('db-list-placeholder');
            const createDbForm = document.getElementById('create-db-form');
            const newDbNameInput = document.getElementById('new-db-name');
            const newDbDescInput = document.getElementById('new-db-desc');
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');
            const signOutBtn = document.getElementById('sign-out-btn');

            const importSqlBtn = document.getElementById('import-sql-btn');
            const importSqlModal = document.getElementById('import-sql-modal');
            const importSqlForm = document.getElementById('import-sql-form');
            const cancelImportSqlBtn = document.getElementById('cancel-import-sql-btn');
            const submitImportSqlBtn = document.getElementById('submit-import-sql-btn');
            const sqlFileInput = document.getElementById('sql-file-input');
            const sqlScriptTextarea = document.getElementById('import-sql-script');

            // Modal elements
            const deleteModal = document.getElementById('delete-modal');
            const modalDbName = document.getElementById('modal-db-name');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            let dbToDeleteId = null;
            let initialDataLoaded = false;

            /**
             * A wrapper for the native fetch function that automatically includes
             * the Supabase authentication token.
             */
            async function fetchWithAuth(url, options = {}) {
                const token = await getAuthToken();
                if (!token) {
                    // getAuthToken handles redirection, but we must stop execution here by throwing.
                    throw new Error("Authentication token not available. Redirecting to login.");
                }

                const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
                return fetch(url, { ...options, headers });
            }

            async function getAuthToken() {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error || !session || !session.user) {
                    console.error("Authentication error, redirecting to login.", error);
                    localStorage.removeItem('supabase_token');
                    window.location.href = '/login';
                    return null;
                }
                // Return just the access token string for authentication headers.
                return session.access_token;
            }

            function getInitials(fullName) { // --- FIX: Make getInitials more robust ---
                if (!fullName) return '?';
                // Split by space and filter out any empty strings from multiple spaces or trailing spaces
                const names = fullName.trim().split(' ').filter(name => name.length > 0);

                if (names.length === 0) return '?';

                const firstInitial = names[0][0];
                // If there's more than one name, get the last initial, otherwise use an empty string.
                const lastInitial = names.length > 1 ? names[names.length - 1][0] : '';

                return (firstInitial + lastInitial).toUpperCase();
            }


            function openModal(modal) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            }

            const closeModal = (modal) => {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 250);
            };

            async function fetchDatabases() {
                try {
                    const response = await fetchWithAuth('/api/v1/databases');
                    if (!response.ok) throw new Error('Failed to fetch databases');
                    const databases = await response.json();
                    initialDataLoaded = true; // Mark success
                    renderDatabases(databases);
                } catch (error) {
                    console.error(error);
                    initialDataLoaded = false; // Allow retry
                    dbListPlaceholder.textContent = 'Could not load databases.';
                }
            }

            function renderDatabases(databases) {
                dbList.innerHTML = '';
                if (databases.length === 0) {
                    dbList.innerHTML = `<div class="text-center py-10 text-gray-500">No databases found. Create one to get started!</div>`;
                    return;
                }
                databases.forEach(db => {
                    // --- FIX: Programmatic DOM creation to avoid innerHTML and CSP issues ---
                    const dbElement = document.createElement('div');
                    dbElement.className = 'bg-white p-4 rounded-lg shadow-sm flex flex-col md:flex-row items-start md:items-center justify-between border gap-4 md:gap-2';
                    dbElement.setAttribute('data-id', db.id);

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'w-full md:w-auto';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'font-medium text-gray-800';
                    nameSpan.textContent = db.name;
                    const descP = document.createElement('p');
                    descP.className = 'text-sm text-gray-500';
                    descP.textContent = db.description || 'No description';
                    infoDiv.appendChild(nameSpan);
                    infoDiv.appendChild(descP);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'flex items-center gap-2 w-full md:w-auto justify-end flex-wrap';
                    const openLink = document.createElement('a');
                    openLink.href = `/app/database/${db.name}`;
                    openLink.className = 'open-btn text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 font-semibold';
                    openLink.textContent = 'Open';
                    const exportBtn = document.createElement('button');
                    exportBtn.dataset.dbId = db.id;
                    exportBtn.dataset.dbName = db.name;
                    exportBtn.className = 'export-sql-btn text-sm bg-gray-200 px-3 py-1 rounded-md hover:bg-gray-300';
                    exportBtn.textContent = 'Export SQL';
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn text-sm bg-red-100 text-red-700 px-3 py-1 rounded-md hover:bg-red-200';
                    deleteBtn.textContent = 'Delete';
                    actionsDiv.append(openLink, exportBtn, deleteBtn);

                    dbElement.appendChild(infoDiv);
                    dbElement.appendChild(actionsDiv);
                    dbList.appendChild(dbElement);
                });
            }

            async function handleCreateDatabase(e) {
                e.preventDefault();
                const name = newDbNameInput.value.trim();
                const description = newDbDescInput.value.trim();
                if (!name) return;

                try {
                    const response = await fetchWithAuth('/api/v1/databases', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description }),
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Failed to create database');
                    }
                    fetchDatabases(); // Re-fetch the list
                    newDbNameInput.value = '';
                    newDbDescInput.value = '';
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }

            async function handleDeleteDatabase() {
                if (!dbToDeleteId) return;
                try {
                    const response = await fetchWithAuth(`/api/v1/databases/${dbToDeleteId}`, { method: 'DELETE' });
                    // A 204 No Content means success. Any other status is an error.
                    if (response.status !== 204) {
                        // Try to get a detailed error message from the API response body.
                        let errorDetail = `Failed to delete database. Status: ${response.status}`;
                        try {
                            const err = await response.json();
                            errorDetail = err.detail || errorDetail;
                        } catch (e) { /* Ignore if body is not JSON */ }
                        throw new Error(errorDetail);
                    }
                    // On success, refresh the list and close the modal.
                    fetchDatabases();
                    closeModal(deleteModal);
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            }

            async function handleExportSql(dbId, dbName) {
                try {
                    const response = await fetchWithAuth(`/api/v1/databases/${dbId}/export-sql`);
                    if (!response.ok) throw new Error('Failed to export SQL');
                    
                    const sqlText = await response.text();
                    const blob = new Blob([sqlText], { type: 'application/sql' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `${dbName}_dump.sql`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    alert(`Error exporting SQL: ${error.message}`);
                }
            }

            async function handleImportSql(e) {
                e.preventDefault();
                const name = document.getElementById('import-db-name').value.trim();
                const description = document.getElementById('import-db-desc').value.trim();
                const script = sqlScriptTextarea.value.trim();

                if (!name || !script) {
                    alert('Database name and SQL script are required.');
                    return;
                }

                submitImportSqlBtn.disabled = true;
                submitImportSqlBtn.textContent = 'Importing...';

                try {
                    const response = await fetchWithAuth('/api/v1/databases/import-sql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, description, script }),
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Failed to import database');
                    }
                    closeModal(importSqlModal);
                    fetchDatabases(); // Re-fetch the list
                } catch (error) {
                    alert(`Error: ${error.message}`);
                } finally {
                    submitImportSqlBtn.disabled = false;
                    submitImportSqlBtn.textContent = 'Import Database';
                }
            }

            dbList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const dbItem = deleteBtn.closest('[data-id]');
                    dbToDeleteId = dbItem.dataset.id;
                    const dbName = dbItem.querySelector('span.font-medium').textContent;
                    modalDbName.textContent = dbName;
                    deleteModal.classList.remove('hidden');
                    setTimeout(() => deleteModal.classList.remove('opacity-0'), 10);
                    return; // Stop further processing
                }

                const exportBtn = e.target.closest('.export-sql-btn');
                if (exportBtn) {
                    const dbId = exportBtn.dataset.dbId;
                    const dbName = exportBtn.dataset.dbName;
                    exportBtn.textContent = 'Exporting...';
                    exportBtn.disabled = true;
                    handleExportSql(dbId, dbName).finally(() => {
                        exportBtn.textContent = 'Export SQL';
                        exportBtn.disabled = false;
                    });
                }
            });

            createDbForm.addEventListener('submit', handleCreateDatabase);
            cancelDeleteBtn.addEventListener('click', () => closeModal(deleteModal));
            confirmDeleteBtn.addEventListener('click', handleDeleteDatabase);
            
            importSqlBtn.addEventListener('click', () => {
                importSqlForm.reset();
                openModal(importSqlModal);
            });

            cancelImportSqlBtn.addEventListener('click', () => closeModal(importSqlModal));
            importSqlForm.addEventListener('submit', handleImportSql);

            sqlFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => { sqlScriptTextarea.value = event.target.result; };
                    reader.readAsText(file);
                }
            });

            profileBtn.addEventListener('click', () => {
                profileDropdown.classList.toggle('hidden');
            });


            signOutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                localStorage.removeItem('supabase_token');
                window.location.href = '/login';
            });

            // Initial Load
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION' || event === 'TOKEN_REFRESHED') {
                    if (session) {
                        localStorage.setItem('supabase_token', session.access_token);
                        const user = session.user;
                        const fullName = user.user_metadata?.full_name;
                        
                        // Populate profile dropdown
                        document.getElementById('profile-btn').textContent = getInitials(fullName);
                        document.getElementById('profile-name').textContent = fullName || 'User';
                        document.getElementById('profile-email').textContent = user.email;

                        // Fetch data if it hasn't been loaded yet. This handles token refresh on initial load.
                        if (!initialDataLoaded) {
                            fetchDatabases();
                        }
                    } else {
                        window.location.href = '/login';
                    }
                } else if (event === 'SIGNED_OUT') {
                    window.location.href = '/login';
                }
            });
        });
    </script>
</body>
</html>